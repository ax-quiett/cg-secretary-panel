<!-- Secretary ‚Äî Capital Group ¬∑ –°–µ–∫—Ä–µ—Ç–∞—Ä—å

     (2025-11-12 ¬∑ strict button disable fix; fast confirm; bg lighter) -->

<!doctype html>

<html lang="ru">

<head>

<meta charset="utf-8" />

<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Capital Group ¬∑ –°–µ–∫—Ä–µ—Ç–∞—Ä—å</title>

<style>

  :root{

    --bg:#101217;

    --card:#15171c;

    --muted:#8a93a6;

    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --link:#60a5fa; --line:#232634;

  }

  html,body{margin:0;padding:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}

  .wrap{max-width:900px;margin:0 auto;padding:16px}

  .card{background:#15171c;border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .btn{padding:10px 14px;border-radius:10px;border:1px solid #2c3242;background:#12151b;color:#ffffff;cursor:pointer}

  .btn[disabled]{opacity:.55;cursor:not-allowed}

  .btn.ok{border-color:#1c7c43;background:#0f1f17}

  .btn.warn{border-color:#9a6a12;background:#251a06}

  .btn.err{border-color:#b32626;background:#2a0f0f}

  .muted{color:var(--muted);font-size:12px}

  .title{font-weight:600}

  .status{font-weight:700}

  .status.off{color:#94a3b8}

  .status.on{color:#22c55e}

  .status.lunch{color:#f59e0b}

  .status.break{color:#f97316}

  .table{width:100%;border-collapse:collapse}

  .table th,.table td{border-bottom:1px solid #232634;padding:8px 6px;font-size:14px}

  input{background:#0e1117;color:#e5e7eb;border:1px solid #2b3243;border-radius:10px;padding:8px 10px}

  .toast{position:fixed;right:12px;bottom:12px;background:#101218;border:1px solid #32384a;border-radius:12px;padding:10px 12px;max-width:320px;box-shadow:0 10px 30px rgba(0,0,0,.4)}

  .hide{display:none !important}

  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3142;background:#11141b;border-radius:999px;padding:4px 8px}

  .spin{display:inline-block;width:12px;height:12px;border:2px solid #64748b;border-top-color:transparent;border-radius:50%;animation:rot .8s linear infinite}

  @keyframes rot{to{transform:rotate(360deg)}}

</style>

</head>

<body>

<div class="wrap">

  <div class="card row" style="justify-content:space-between">

    <div class="title">Capital Group ¬∑ –°–µ–∫—Ä–µ—Ç–∞—Ä—å</div>

    <div class="muted">–í—Ö–æ–¥: <b><?= ctx.ok ? (ctx.name||'‚Äî') : 'demo' ?></b></div>

  </div>



  <div class="card">

    <div class="row" style="justify-content:space-between">

      <div>

        <span class="title">–ú–æ–π —Å—Ç–∞—Ç—É—Å ‚Äî </span>

        <span id="my-status" class="status off">‚õî OFF</span>

        <span id="status-spin" class="spin hide" aria-hidden="true"></span>

      </div>

      <div class="muted chip">‚≠ê –°—Ä–µ–¥–Ω—è—è QC –∑–∞ 14 –¥–Ω–µ–π: <span id="qc-avg">‚Äî</span></div>

    </div>

    <div class="row" style="margin-top:10px">

      <button class="btn ok"   id="btn-in">‚úÖ –ü—Ä–∏—à—ë–ª</button>

      <button class="btn warn" id="btn-lunch">üçΩÔ∏è –û–±–µ–¥</button>

      <button class="btn"      id="btn-back-lunch">‚Ü©Ô∏é –í–µ—Ä–Ω—É–ª—Å—è</button>

      <button class="btn"      id="btn-break">‚òï –ü–µ—Ä–µ—Ä—ã–≤</button>

      <button class="btn"      id="btn-back-break">‚Ü©Ô∏é –í–µ—Ä–Ω—É–ª—Å—è</button>

      <button class="btn err"  id="btn-out">‚õî –£—à—ë–ª</button>

    </div>

    <div class="muted" style="margin-top:6px">

    </div>

  </div>



  <div class="card">

    <div class="row">

      <label>–î–∞—Ç–∞: <input type="date" id="day-date"></label>

      <button class="btn" id="day-show">–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π –¥–µ–Ω—å</button>

    </div>

    <div id="day-box" class="muted" style="margin-top:8px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  </div>



  <div class="card">

    <div class="row">

      <label>–Ø–∫–æ—Ä–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–¥–µ–ª–∏: <input type="date" id="week-anchor"></label>

      <button class="btn" id="week-show">–ü–æ–∫–∞–∑–∞—Ç—å –º–æ—é –Ω–µ–¥–µ–ª—é</button>

    </div>

    <div id="week-box" class="muted" style="margin-top:8px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  </div>



  <div class="card">

    <div class="row">

      <span class="title">–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ (—Å–∫—Ä—ã—Ç–æ)</span>

      <input id="log-limit" value="50" style="width:80px" />

      <button class="btn" id="log-show">–ü–æ–∫–∞–∑–∞—Ç—å</button>

    </div>

    <div style="overflow:auto;max-height:260px;margin-top:10px">

      <table class="table" id="tbl-logs">

        <thead><tr><th>–í—Ä–µ–º—è</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr></thead>

        <tbody></tbody>

      </table>

    </div>

  </div>

</div>



<div id="toast" class="toast hide"><div id="toast-msg"></div></div>



<script>

(function(){

  // ==== CTX ====

  var CTX = {

    role: "<?= ctx.role || '' ?>",

    name: "<?= ctx.name || '' ?>",

    token: "<?= ctx.token || '' ?>",

    ok: <?= ctx.ok ? 'true' : 'false' ?>

  };



  // ==== helpers ====

  function $(s, r){ return (r||document).querySelector(s); }

  function $$(s, r){ return Array.from((r||document).querySelectorAll(s)); }

  function sleep(ms){ return new Promise(function(res){ setTimeout(res, ms); }); }

  function norm(s){ return String(s||'').trim().toLowerCase(); }

  function eqName(a,b){ return norm(a)===norm(b); }

  function toast(msg){ var t=$("#toast"), m=$("#toast-msg"); m.textContent=msg; t.classList.remove("hide"); setTimeout(function(){t.classList.add("hide");}, 3200); }



  // —Å–ø–∏–Ω–Ω–µ—Ä –æ–∫–æ–ª–æ —Å—Ç–∞—Ç—É—Å–∞

  var spin = $("#status-spin");

  function spinOn(){ spin.classList.remove("hide"); }

  function spinOff(){ spin.classList.add("hide"); }



  // —Ñ–æ—Ä–º–∞—Ç d => dd.mm.yy

  function fmtDMY(dIso){

    var d = (dIso||'').slice(0,10);

    var parts = d.split('-'); var y=parts[0], m=parts[1], dd=parts[2];

    if(!y||!m||!dd) return dIso||'';

    return dd+"."+m+"."+String(y).slice(2);

  }



  // ==== RPC queue with 429 backoff ====

  var q=[]; var busy=false;

  function enqueue(fn, args, retries){

    args = args||[]; retries = (retries==null)?2:retries;

    return new Promise(function(resolve,reject){

      q.push({fn:fn,args:args,retries:retries,resolve:resolve,reject:reject});

      run();

    });

  }

  function run(){

    if(busy||!q.length) return;

    busy=true;

    var t=q.shift();

    rpc(t.fn,t.args,t.retries).then(function(r){

      t.resolve(r);

    }).catch(function(e){

      t.reject(e);

    }).finally(function(){

      busy=false; if(q.length) run();

    });

  }

  function rpc(fnName,args,retries){

    var call = function(){

      return new Promise(function(res,rej){

        google.script.run.withSuccessHandler(res).withFailureHandler(rej)[fnName].apply(google.script.run, args);

      });

    };

    var a=0,last=null;

    return (function loop(){

      return call().catch(function(e){

        var msg=(e && (e.message||e.toString()))||"";

        try{ google.script.run.api_frontLog("CLIENT","fail",String(msg), String(e && e.stack || ""), {}); }catch(_){}

        if(/429|Too Many|Rate|426/i.test(msg) && a<=retries){

          var wait=Math.min(1500*Math.pow(2,a),5000);

          a++; return sleep(wait).then(loop);

        }

        last=e; throw e;

      });

    })();

  }



  // ==== API ====

  var API = {

    myStatus:  function(){ return enqueue('api_myStatus', [CTX.token]); },

    statuses:  function(){ return enqueue('api_statuses', []); },

    qcAvg:     function(d){ return enqueue('api_qcAvg',[d==null?14:d]); },

    quick:     function(event){ return enqueue('api_quickEventSecure',[event, CTX.token]); },

    setStatus: function(name,status){ return enqueue('api_setStatusSecure',[name,status, CTX.token]); },

    dayMenu:   function(d){ return enqueue('api_dayMenu',[d]); },

    myWeek:    function(name,anchor){ return enqueue('api_myWeek',[name,anchor]); },

    logs:      function(f,t,q,lim){ return enqueue('api_errorsList',[f,t,q,lim]); }

  };



  // ==== UI state ====

  var elStatus = $("#my-status");

  var btnIn = $("#btn-in");

  var btnLunch = $("#btn-lunch");

  var btnBackL = $("#btn-back-lunch");

  var btnBreak = $("#btn-break");

  var btnBackB = $("#btn-back-break");

  var btnOut = $("#btn-out");



  function dis(b, v){ if(!b) return; if(v){ b.setAttribute("disabled","disabled"); } else { b.removeAttribute("disabled"); } }



  // –ñ–µ—Å—Ç–∫–∞—è –ª–æ–≥–∏–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫

  function setButtonsByStatus(s){

    // reset

    dis(btnIn,false); dis(btnLunch,false); dis(btnBackL,false);

    dis(btnBreak,false); dis(btnBackB,false); dis(btnOut,false);



    if(s==="OFF"){

      // –¢–æ–ª—å–∫–æ ¬´–ü—Ä–∏—à—ë–ª¬ª

      dis(btnIn,false);

      dis(btnLunch,true); dis(btnBackL,true);

      dis(btnBreak,true); dis(btnBackB,true);

      dis(btnOut,true);

    } else if(s==="–ù–∞ –ª–∏–Ω–∏–∏"){

      // ¬´–û–±–µ–¥¬ª, ¬´–ü–µ—Ä–µ—Ä—ã–≤¬ª, ¬´–£—à—ë–ª¬ª

      dis(btnIn,true);

      dis(btnLunch,false); dis(btnBackL,true);

      dis(btnBreak,false); dis(btnBackB,true);

      dis(btnOut,false);

    } else if(s==="–û–±–µ–¥"){

      // –¢–æ–ª—å–∫–æ ¬´–í–µ—Ä–Ω—É–ª—Å—è —Å –æ–±–µ–¥–∞¬ª

      dis(btnIn,true);

      dis(btnLunch,true);

      dis(btnBackL,false);

      dis(btnBreak,true);

      dis(btnBackB,true);

      dis(btnOut,true);

    } else if(s==="–ü–µ—Ä–µ—Ä—ã–≤"){

      // –¢–æ–ª—å–∫–æ ¬´–í–µ—Ä–Ω—É–ª—Å—è —Å –ø–µ—Ä–µ—Ä—ã–≤–∞¬ª

      dis(btnIn,true);

      dis(btnLunch,true);

      dis(btnBackL,true);

      dis(btnBreak,true);

      dis(btnBackB,false);

      dis(btnOut,true);

    } else {

      // —Ñ–æ–ª–±–µ–∫ –∫–∞–∫ ¬´–ù–∞ –ª–∏–Ω–∏–∏¬ª

      dis(btnIn,true);

      dis(btnLunch,false); dis(btnBackL,true);

      dis(btnBreak=false,false); dis(btnBackB=true,true); // –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –≤ –ª–∏–Ω–∏–∏

      dis(btnOut,false);

    }

  }



  function setStatusView(s){

    var map = {

      "OFF": {txt:"‚õî OFF", cls:"off"},

      "–ù–∞ –ª–∏–Ω–∏–∏": {txt:"‚úÖ –ù–∞ –ª–∏–Ω–∏–∏", cls:"on"},

      "–û–±–µ–¥": {txt:"üçΩÔ∏è –û–±–µ–¥", cls:"lunch"},

      "–ü–µ—Ä–µ—Ä—ã–≤": {txt:"‚òï –ü–µ—Ä–µ—Ä—ã–≤", cls:"break"}

    };

    var v = map[s] || map["OFF"];

    elStatus.textContent = v.txt;

    elStatus.className = "status " + v.cls;

    setButtonsByStatus(s);

  }



  // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ + –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞

  function optimisticSet(status, doCall){

    // –±–ª–æ–∫–∏—Ä—É–µ–º –í–°–ï –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–¥–≤–æ–π–Ω—ã—Ö —Ç–∞–ø–æ–≤¬ª

    [btnIn,btnLunch,btnBackL,btnBreak,btnBackB,btnOut].forEach(function(b){ dis(b,true); });

    spinOn();

    var prevTxt = elStatus.textContent;

    var prevCls = elStatus.className;

    setStatusView(status); // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ



    return doCall()

      .then(function(){ return sleep(150); })         // –∫–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ –ø–æ–¥ echo

      .then(function(){ return refreshMyStatus(true); })

      .catch(function(){

        // –æ—Ç–∫–∞—Ç

        elStatus.textContent = prevTxt;

        elStatus.className = prevCls;

        // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–ª–∞—Å—Å–∞

        var cur = /status on/.test(prevCls) ? "–ù–∞ –ª–∏–Ω–∏–∏" :

                  /status lunch/.test(prevCls) ? "–û–±–µ–¥" :

                  /status break/.test(prevCls) ? "–ü–µ—Ä–µ—Ä—ã–≤" : "OFF";

        setButtonsByStatus(cur);

        toast("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å");

      })

      .finally(function(){

        spinOff();

      });

  }



  function refreshMyStatus(silent){

    var p1 = API.myStatus();

    var p2 = API.qcAvg(14);

    return Promise.all([p1,p2]).then(function(arr){

      var r = arr[0]||{};

      var avg = arr[1]||{};

      var s = (r && r.status) ? r.status : "OFF";

      setStatusView(s);

      $("#qc-avg").textContent = (avg && avg[CTX.name]!=null) ? avg[CTX.name] : "‚Äî";

    }).catch(function(){ if(!silent) toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å"); });

  }



  // –∫–Ω–æ–ø–æ—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –≤—Ä–µ–º—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

  function lock(btn){

    if(!btn) return function(){};

    var txt=btn.textContent;

    btn.setAttribute("disabled","disabled");

    btn.textContent="‚Ä¶";

    return function(){

      btn.removeAttribute("disabled");

      btn.textContent=txt;

    };

  }



  // ==== actions ====

  function actQuick(event, btn){

    var unlock = lock(btn);

    optimisticSet(mapEventToStatus(event), function(){ return API.quick(event); })

      .finally(function(){ unlock(); });

  }

  function actSet(status, btn){

    var unlock = lock(btn);

    optimisticSet(status, function(){ return API.setStatus('', status); }) // –∏–º—è –∏–∑ —Ç–æ–∫–µ–Ω–∞

      .finally(function(){ unlock(); });

  }

  function mapEventToStatus(ev){

    var map = {IN:"–ù–∞ –ª–∏–Ω–∏–∏", OUT:"OFF", LUNCH_START:"–û–±–µ–¥", LUNCH_END:"–ù–∞ –ª–∏–Ω–∏–∏", BREAK_START:"–ü–µ—Ä–µ—Ä—ã–≤", BREAK_END:"–ù–∞ –ª–∏–Ω–∏–∏"};

    return map[ev] || "–ù–∞ –ª–∏–Ω–∏–∏";

  }



  // –ö–Ω–æ–ø–∫–∏

  btnIn.addEventListener("click",   function(){ actQuick("IN", btnIn); });

  btnOut.addEventListener("click",  function(){ actQuick("OUT", btnOut); });

  btnLunch.addEventListener("click",function(){ actQuick("LUNCH_START", btnLunch); });

  btnBackL.addEventListener("click",function(){ actQuick("LUNCH_END", btnBackL); });

  btnBreak.addEventListener("click",function(){ actQuick("BREAK_START", btnBreak); });

  btnBackB.addEventListener("click",function(){ actQuick("BREAK_END", btnBackB); });



  // ==== Day (my roles) ====

  var dayInput = $("#day-date");

  function todayIso(){ return new Date().toISOString().slice(0,10); }

  dayInput.value = todayIso();

  $("#day-show").addEventListener("click", function(){

    var unlock = lock($("#day-show"));

    var box = $("#day-box");

    box.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    var d = dayInput.value || todayIso();

    API.dayMenu(d).then(function(r){

      if(!r || !r.hours || !r.hours.length){

        box.innerHTML = '<span class="muted">–ü—É—Å—Ç–æ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Roster –Ω–∞ '+fmtDMY(d)+')</span>';

        return;

      }

      var rows = r.hours.map(function(h){

        var calls = (h.CALLS||[]).some(function(n){ return eqName(n, CTX.name); }) ? "‚úÖ" : "‚Äî";

        var meet  = eqName(h.MEET||"", CTX.name) ? "‚úÖ" : "‚Äî";

        return '<tr><td>'+h.from+'‚Äì'+h.to+'</td><td style="text-align:center">'+calls+'</td><td style="text-align:center">'+meet+'</td></tr>';

      }).join('');

      box.innerHTML =

        '<div class="muted" style="margin-bottom:6px">–î–∞—Ç–∞: '+fmtDMY(d)+'</div>'+

        '<table class="table">'+

        '<thead><tr><th>–í—Ä–µ–º—è</th><th>CALLS (—è)</th><th>MEET (—è)</th></tr></thead>'+

        '<tbody>'+rows+'</tbody>'+

        '</table>';

    }).catch(function(){ box.textContent="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; })

      .finally(function(){ unlock(); });

  });



  // ==== My week (shift codes) ====

  var weekInput = $("#week-anchor");

  weekInput.value = dayInput.value;

  $("#week-show").addEventListener("click", function(){

    var unlock = lock($("#week-show"));

    var box = $("#week-box");

    box.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    API.myWeek(CTX.name, weekInput.value).then(function(r){

      if(!r || !r.days || !r.days.length){

        box.innerHTML = '<span class="muted">–ü—É—Å—Ç–æ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–µ–¥–µ–ª—é)</span>';

        return;

      }

      var head = '<tr><th>–î–µ–Ω—å</th>'+r.days.map(function(d){ return '<th>'+fmtDMY(d)+'</th>'; }).join('')+'</tr>';

      var body = '<tr><td>'+CTX.name+'</td>'+r.shifts.map(function(c){ return '<td>'+c+'</td>'; }).join('')+'</tr>';

      box.innerHTML = '<table class="table"><thead>'+head+'</thead><tbody>'+body+'</tbody></table>';

    }).catch(function(){ box.textContent="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; })

      .finally(function(){ unlock(); });

  });



  // ==== Logs (light) ====

  $("#log-show").addEventListener("click", function(){

    var limit = Math.max(10, +($("#log-limit").value||50));

    var tb = $("#tbl-logs tbody");

    tb.innerHTML = '<tr><td colspan="4" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';

    var f="2000-01-01", t="2100-01-01";

    API.logs(f,t,"", limit).then(function(rows){

      tb.innerHTML = (rows||[]).slice(-limit).map(function(r){

        return '<tr>'+

          '<td class="muted">'+(String(r.ts||'').replace('T',' '))+'</td>'+

          '<td class="muted">'+(r.source||'')+'</td>'+

          '<td>'+(r.action||'')+'</td>'+

          '<td class="muted">'+(r.message||'')+'</td>'+

        '</tr>';

      }).join('') || '<tr><td colspan="4" class="muted">–ü—É—Å—Ç–æ</td></tr>';

    }).catch(function(){

      tb.innerHTML = '<tr><td colspan="4" class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';

    });

  });



  // ==== initial ====

  refreshMyStatus(true).then(function(){

    // —Ñ–æ—Ä—Å–∏–º –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–∫–∞–∑ ‚Äî —á—Ç–æ–±—ã –ø–æ–ª—è —Ç–æ—á–Ω–æ –Ω–µ –±—ã–ª–∏ –ø—É—Å—Ç—ã–º–∏

    $("#day-show").click();

    $("#week-show").click();

  });

})();

</script>

</body>

</html>
